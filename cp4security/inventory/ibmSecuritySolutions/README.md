# IBM Security Solutions
This readme provides instructions on how to manually install and configure the Kubernetes cluster to install IBM Security Solutions as part of the  CloudPak for Security.

# Installation

## Pre-install Steps

### Log in to the cluster and set the namespace

The `ibm-security-solutions-prod` chart _must_ be installed into the same namespace as the `ibm-security-foundations-prod` chart. 

- Set the namespace on log in:
  ```
  cloudctl login -n <NAMESPACE>
  ```

## Installing the Chart


### Execute Pre-Reqs for Cloud Pak for Security Solutions

A Fully Qualified Domain Name (FQDN) must be created for the Cloud Pak for Security application. It must not be same as the Red Hat OpenShift Container Platform (RHOCP) cluster FQDN or IBM Cloud Platform Common Services FQDN or any other FQDN associated with the RHOCP cluster. The application FQDN must point to the RHOCP cluster public IP address or hostname.

A Transport Layer Security (TLS) certificate must be provided for the application FQDN, which may be either a certificate for a given domain (e.g. my.test.com) or a wildcard certificate (e.g. *.test.com). 

The certificate may be: 
- Signed by a well-known Certificate of Authority (CA).
- Not signed by a well-known Certificate of Authority
   - The CA certificate must be passed to the script as [ -ca CACertFile ].
   - The combined certificate + CA certificate is passed as the [ -cert certfile ]. 
- A self-signed certificate generated by the script for a given FQDN, (Only recommended for use in non-production environments).

The script `preInstall.sh` is used to manage pre-requisite parameters.

The script performs the following actions:
- stores cluster IBM Cloud Platform Common Services administrator credentials in a secret
- configures provided TLS certificate for the application domain
- or generates TLS certificates for the application domain
- loads CA certificate when TLS certificate is generated by custom CA


The script possible parameters are:

|  Parameter                  | Comment 
| --------------------------- | -------------------------------------------
| -n NAMESPACE                | to use provided namespace instead of current |
| -force                      | to replace existing secrets | 
| -cluster username:password  | to create secret with IBM Cloud Platform Common Services cluster admin credentials |
| -cert certfile -key keyfile | to associate Cloud Pak for Security ingress with a provided TLS cert and key file | 
| -ca certfile                | to optionally provide certificate of CA if not well known |
| -selfsigned FQDN            | to generate self-signed certificate for FQDN |


#### Create cluster credentials
##### Create cluster credentials with customer provided Certificate and Key

```
ibm-security-solutions-prod/ibm_cloud_pak/pak_extensions/pre-install/preInstall.sh -cluster <ICPadmin>:<ICPpassword> -cert <CertFile> -key <KeyFile> [ -ca <CACertFile> ]
```

**-or-**

#####  Create cluster credentials with Cloud Pak for Security self-signed auto-generated certificate (not recommended in production environment)

```
ibm-security-solutions-prod/ibm_cloud_pak/pak_extensions/pre-install/preInstall.sh -cluster <ICPadmin>:<ICPpassword> -selfsigned <FQDN>
```


### Check Prerequisites

A script is provided in the `ibm-security-foundations-prod` chart which should be run to validate pre-requisites before beginning the install of `ibm-security-solutions-prod`. 

This script is run with the following command : 

```
ibm-security-foundations-prod/ibm_cloud_pak/pak_extensions/pre-install/checkprereq.sh -n <NAMESPACE> --solutions
```

Output will display the default storage class and when successfull will indicate : 

```
INFO: ibm-security-solutions prerequisites are OK
```

Any errors should be resolved before continuing.


### Install the Chart

To install the chart, you must provide
- release name
- namespace
- required user-specified values

A release name must be specified when installing the chart. It is suggested to use `ibm-security-solutions-prod` as the default/initial release name.

The `ibm-security-solutions-prod` chart _must_ be installed into the same namespace as the `ibm-security-foundations-prod` chart. Before running the helm installation, run the following command to enter that namespace
```
oc project <NAMESPACE>
```

Certain values _must_ be provided when installing the chart. 

| Parameter | Note |
| --- | --- |
| `global.storageClass` | Required. Note, if the `global.storageClass` applies to all PVCs, including Postgres, it must support `fsGroup` so that mounted PVCs are writable. |
| `global.cluster.hostname` | Deprecated (Should only be used for upgrade scenarios when parameter was already defined) |
| `global.cluster.icphostname` | Required. FQDN of the ICP console |
| `global.domain.default.domain` | Required|
| `global.repository` | Required if installing [using IBM Passport Advantage](https://www.ibm.com/support/knowledgecenter/SSTDPP_1.3.0/cp4s_v1r3/docs/security-pak/ppa_download.html), you must specify a docker registry host (and path if relevant). Note that the repository you specify here must match the repository specified during the pre-install of ibm-security-foundations-prod (which creates an image pull secret for that repository). |
| `global.repositoryType` | If installing from Passport Advantage archives, change to `local` |

The full set of configuration values are in the [configuration](#configuration) section below.

To specify these values for a command line installation, either edit the values file or pass the values on the command line.

To edit the values file
- Edit the `ibm-security-solutions-prod/values.yaml` file (or optionally copy the file to another directory)
- Run the helm command with the additional option `--values <PATH>/values.yaml`

To pass the values on the command line
- Run the helm command with an additional `--set <VARNAME>=<VALUE>` option for each value
- For example: `--set global.repository=cp.icr.io/cp/cp4s [...]`

#### Install IBM Cloud Security Advisor Adapter	
Optionally install the [IBM Cloud Security Advisor Adapter](https://www.ibm.com/support/knowledgecenter/SSTDPP_1.3.0/cp4s_v1r3/docs/scp-core/csa-adapter-cases.html) by adding this parameter as part of the install command ` --set global.ibm-isc-csaadapter-prod.enabled=true`.

Before running the helm install log in to the cluster and set the namespace.

To install the chart run the following command:

```
helm install --name <RELEASE_NAME> --namespace=<NAMESPACE>  ./ibm-security-solutions-prod --tls --values <PATH>/values.yaml [--set options]
```

### Verify the Chart

Once the install of `ibm-security-solutions-prod` has completed, to verify the outcome execute the following:

1. Using the <RELEASE_NAME> specified, the following commands can be used to view the status of the installation.

 


a. `helm ls <RELEASE_NAME> --tls`

__Expected Result:__ The `ibm-security-solutions-prod` should be in a `Deployed` state.

b. `helm status <RELEASE_NAME> --tls`

__Expected Result:__ The `ibm-security-solutions-prod` resources should listed as `STATUS: DEPLOYED` and list all resources deployed.

c. Execute the helm tests to verify installation `helm test <RELEASE_NAME> â€“cleanup --tls`

__Expected Result:__ All Helm Tests should have a status of `PASSED`


d. The [checkcr.sh](ibm-security-foundations-prod/ibm_cloud_pak/pak_extensions/support/checkcr.sh) script checks status of the CP4S installation process. The script should be executed specifying the namespace to which the CP4S was deployed by the customer.

`ibm-security-foundations-prod/ibm_cloud_pak/pak_extensions/support/checkcr.sh <NAMESPACE> --all`

__Expected Result:__ There are no  failures returned from executing  `checkcr.sh`



### Upgrade or update the installation

If you have previously installed Cloud Pak for Security, you can upgrade to a later version of the software or apply updates to configuration values by running the helm `upgrade` command.

To upgrade the installation, first run the command:
```
ibm-security-solutions-prod/ibm_cloud_pak/pak_extensions/pre-upgrade/preUpgrade.sh [ -n <NAMESPACE> ]
```
Prior to executing the `helm upgrade` command below complete the steps in [Check prerequisites](#check-prerequisites)

Then run the command:
```
helm upgrade <RELEASE_NAME> --namespace=<NAMESPACE>  ./ibm-security-solutions-prod --tls --values <PATH>/values.yaml [--set options] 
```

where passing `--values <PATH>/values.yaml` and `[--set options]` are as described in [Install the chart](#install-the-chart) above.


### Uninstall the Chart

To uninstall the chart, run the following command:
```
helm delete --purge <RELEASE_NAME> --tls --timeout 600
```

The following script must be run as follows: 
```
ibm-security-solutions-prod/ibm_cloud_pak/pak_extensions/post-delete/Cleanup.sh [ -n <NAMESPACE> ] --nowait --all 
```
